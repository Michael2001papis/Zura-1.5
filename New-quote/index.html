<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>יצירת הצעת מחיר</title>
  <link rel="stylesheet" href="../CSS/common.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      direction: rtl;
      text-align: center;
      margin: 0;
      padding: 0;
      background-color: #f1f1f1;
      color: #333;
      overflow-x: hidden; /* מונע גלילה אופקית */
    }

    /* כותרת וניווט עליון */
    .page-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #fff;
      padding: 24px 12px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .page-header h1 {
      margin: 0 0 8px 0;
      font-size: 1.8rem;
    }
    .page-header nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .page-header nav a {
      text-decoration: none;
    }
    .page-header nav a button {
      background: #555;
      color: #fff;
      border: none;
      border-radius: 24px;
      padding: 8px 14px;
      cursor: pointer;
      transition: background .25s ease, transform .2s ease;
      white-space: normal;
    }
    .page-header nav a button:hover { background:#777; transform: translateY(-1px); }

    .container {
      width: 100%;
      max-width: 1100px;
      overflow-x: auto;
      padding: 20px;
      margin: 24px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      text-align: right;
    }

    /* טופס עליון */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 16px 20px;
      margin-bottom: 16px;
      align-items: end;
    }
    .form-grid label { font-weight: 700; margin-top: 0; }
    .form-grid input, .form-grid textarea, .form-grid select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dcdcdc;
      background: #fafafa;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
      box-sizing: border-box;
    }
    .form-grid input:focus, .form-grid textarea:focus, .form-grid select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102,126,234,.12);
      background: #fff;
    }
    .form-grid textarea { grid-column: 1 / -1; }

    label { display: block; font-weight: bold; margin: 0 0 6px 0; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      table-layout: fixed; /* מונע גלישה של תאים */
    }
    th, td {
      padding: 12px 10px;
      border: 1px solid #eee;
      text-align: center;
      vertical-align: middle;
      font-size: .95rem;
      word-break: break-word; /* שבירת טקסט ארוך */
    }
    /* שדות כמות ומחיר – יישור ומידות נוחות */
    .quantity,
    .price-per-unit {
      text-align: center;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dcdcdc;
      background: #fafafa;
      width: 100%;
      max-width: 140px;
      box-sizing: border-box;
    }
    /* ביטול החצים בשדות מספר למראה נקי יותר */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(odd) { background: #fafafa; }
    tbody tr:hover { background: #f2f5ff; }

    .summary {
      margin-top: 16px;
      background: #f9fbff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      text-align: center;
      font-weight: 600;
    }

    .buttons {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .buttons button, #addRow {
      margin: 5px;
      min-width: 160px;
      white-space: normal; /* מאפשר שבירת שורה בכפתורים */
    }

    .hidden { display: none; }

    /* רספונסיביות לטבלאות */
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      #calculationTable thead { display: none; }
      #calculationTable tr { display: block; margin-bottom: 10px; }
      #calculationTable td { display: block; text-align: right; padding: 10px; border: 1px solid #e6e6e6; }
      #calculationTable td:before { content: attr(data-label); font-weight: bold; display: block; margin-bottom: 4px; color: #555; }
    }

    /* אזור החתימה */
    .signature-section {
      margin-top: 24px;
      border: 1px solid #e5e7eb;
      padding: 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
    }
    .signature-section h3 { margin: 0 0 8px 0; }
    .signature-section canvas { border: 1px solid #aaa; display: block; margin: 10px auto; border-radius: 8px; width: 100%; height: auto; }

    /* רספונסיביות כללית */
    @media (max-width: 480px) {
      .page-header h1 { font-size: 1.4rem; }
      .page-header { padding: 18px 10px; }
      .container { margin: 16px auto; padding: 16px; border-radius: 14px; }
      .summary { grid-template-columns: 1fr; }
      .buttons button, #addRow { min-width: 140px; }
      th, td { font-size: .9rem; padding: 10px 8px; }
      .quantity, .price-per-unit { max-width: 100%; }
    }

    /* התאמה ממוקדת ל-Galaxy S20 Ultra (390–420px) */
    @media (min-width: 390px) and (max-width: 420px) {
      .page-header { padding: 14px 8px; }
      .page-header h1 { font-size: 1.25rem; }
      .page-header nav { gap: 6px; display: flex; flex-wrap: wrap; justify-content: center; }
      .page-header nav a { flex: 1 1 calc(50% - 6px); display: flex; justify-content: center; }
      .page-header nav a button { padding: 6px 10px; font-size: .9rem; width: 100%; }

      .container { padding: 12px; border-radius: 12px; margin: 12px auto; }
      .form-grid { gap: 10px; grid-template-columns: 1fr; }
      .form-grid input, .form-grid textarea, .form-grid select { padding: 9px 10px; font-size: .95rem; }

      table { table-layout: fixed; }
      th, td { padding: 8px 6px; font-size: .86rem; }
      #calculationTable td { padding: 8px 6px; }
      #calculationTable td:before { margin-bottom: 2px; font-size: .82rem; }
      .quantity, .price-per-unit { max-width: 100%; }

      .summary { gap: 8px; }
      .buttons { gap: 8px; }
      .buttons button, #addRow { min-width: 115px; font-size: .9rem; padding: 8px 10px; white-space: normal; }

      .signature-section canvas { width: 100%; height: auto; }
    }
  </style>
</head>
<body>

  <header class="page-header">
    <h1>יצירת הצעת מחיר</h1>
    <nav>
      <a href="../index.html"><button>עמוד הבית</button></a>
      <a href="../GeneralProjectsPage/index.html"><button>פרויקטים</button></a>
      <a href="../Contact/index.html"><button>צור קשר</button></a>
      <a href="../Developerrights/index.html"><button>זכויות המפתח</button></a>
    </nav>
  </header>

  <div class="container">
    <div class="form-grid">
      <div>
        <label for="quoteTitle">כותרת הצעת מחיר:</label>
        <input type="text" id="quoteTitle" placeholder="הכנס כותרת">
      </div>
      <div>
        <label for="recipient">לכבוד:</label>
        <input type="text" id="recipient" placeholder="שם מקבל ההצעה">
      </div>
      <div style="grid-column:1 / -1;">
        <label for="tableData">נתוני טבלה (JSON - לא חובה):</label>
        <textarea id="tableData" rows="3" placeholder='לדוגמה: {"מיקום": "דירה", "סוג עבודה": "הריסה", "כמות": 10}'></textarea>
      </div>
    </div>

    <!-- טבלת חישוב ההצעה -->
    <div>
      <button id="addRow" class="add-btn">הוסף שורה</button>
      <table id="calculationTable">
        <thead>
          <tr>
            <th data-label="מיקום">מיקום</th>
            <th data-label="סוג עבודה">סוג עבודה</th>
            <th data-label="כמות">כמות</th>
            <th data-label="אחוז ביצוע">אחוז ביצוע עבודה</th>
            <th data-label="מחיר ל...">מחיר ל...</th>
            <th data-label="סה"כ ללא מע"מ">סה"כ ללא מע"מ</th>
            <th data-label="מע"מ (18%)">מע"מ (18%)</th>
            <th data-label="סה"כ כולל מע"מ">סה"כ כולל מע"מ</th>
            <th data-label="חישוב"></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div class="summary">
        <p>סה"כ ללא מע"מ: <span id="totalWithoutVAT">0</span> ש"ח</p>
        <p>מע"מ (18%): <span id="vat">0</span> ש"ח</p>
        <p>סה"כ כולל מע"מ: <span id="totalWithVAT">0</span> ש"ח</p>
      </div>
      <div class="buttons">
        <button id="homeButton" class="home-btn">עמוד הבית</button>
        <button id="quotationButton" class="quote-btn">הצעת מחיר ללא חשבונית</button>
        <button id="printButton" class="print-btn">הדפסה</button>
        <button id="resetButton" class="reset-btn">איפוס</button>
      </div>
      <button id="rights" class="rights-btn">מפתח האתר/זכויות יוצרים</button>
    </div>

    <!-- אזור חתימה דיגיטלית -->
    <div class="signature-section">
      <h3>חתימה דיגיטלית</h3>
      <canvas id="signatureCanvas" width="400" height="200"></canvas>
      <div>
        <button id="clearSignature">נקה חתימה</button>
      </div>
    </div>

    <!-- כפתור לשמירה והמשך לדף החשבונית -->
    <button onclick="saveQuote()" class="print-btn">שמור והמשך לחשבונית</button>
  </div>

  <script>
    // ניהול טבלת החישוב
    document.addEventListener("DOMContentLoaded", () => {
      const tableBody = document.querySelector("#calculationTable tbody");
      const addRowButton = document.getElementById("addRow");
      const totalWithoutVAT = document.getElementById("totalWithoutVAT");
      const vat = document.getElementById("vat");
      const totalWithVATEl = document.getElementById("totalWithVAT");

      function calculateRow(row) {
        const quantity = parseFloat(row.querySelector(".quantity").value) || 0;
        const percent = parseFloat(row.querySelector(".completion-rate").value) || 100;
        const price = parseFloat(row.querySelector(".price-per-unit").value) || 0;
        const totalNoVAT = quantity * (percent / 100) * price;
        const vatAmount = totalNoVAT * 0.18;
        const totalWithVAT = totalNoVAT + vatAmount;

        row.querySelector(".total-no-vat").textContent = totalNoVAT.toFixed(2);
        row.querySelector(".vat-amount").textContent = vatAmount.toFixed(2);
        row.querySelector(".total-with-vat").textContent = totalWithVAT.toFixed(2);
        calculateOverallTotal();
      }

      function calculateOverallTotal() {
        let sumNoVAT = 0, sumVAT = 0, sumTotal = 0;
        document.querySelectorAll(".total-no-vat").forEach(td => {
          sumNoVAT += parseFloat(td.textContent) || 0;
        });
        document.querySelectorAll(".vat-amount").forEach(td => {
          sumVAT += parseFloat(td.textContent) || 0;
        });
        document.querySelectorAll(".total-with-vat").forEach(td => {
          sumTotal += parseFloat(td.textContent) || 0;
        });

        totalWithoutVAT.textContent = sumNoVAT.toFixed(2);
        vat.textContent = sumVAT.toFixed(2);
        totalWithVATEl.textContent = sumTotal.toFixed(2);
      }

      function createRow() {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td data-label="מיקום">
            <select class="location">
              <option value="דירה">דירה</option>
              <option value="קומה">קומה</option>
              <option value="בית">בית</option>
              <option value="וילה">וילה</option>
              <option value="משרד">משרד</option>
              <option value="אחר">אחר...</option>
            </select>
            <input type="text" class="custom-location hidden" placeholder="הכנס מיקום">
          </td>
          <td data-label="סוג עבודה">
            <select class="work-type">
              <option value="הריסה">הריסה</option>
              <option value="בניה">בניה</option>
              <option value="שפכטל">שפכטל</option>
              <option value="צבע">צבע</option>
              <option value="ריצוף">ריצוף</option>
              <option value="טיח">טיח</option>
              <option value="אינסטלציה">אינסטלציה</option>
              <option value="חשמל">חשמל</option>
              <option value="עבודות גבס">עבודות גבס</option>
              <option value="אחר">אחר...</option>
            </select>
            <input type="text" class="custom-work hidden" placeholder="הכנס סוג עבודה">
          </td>
          <td data-label="כמות">
            <select class="quantity-type">
              <option value="מ\"ר">מ\"ר</option>
              <option value="מ\"א">מ\"א</option>
              <option value="י\"ח">י\"ח</option>
              <option value="כמות כללית">כמות כללית</option>
            </select>
            <input type="number" class="quantity" min="0" step="1" inputmode="numeric" placeholder="הכנס כמות">
          </td>
          <td data-label="אחוז ביצוע">
            <select class="completion-rate">
              <option value="100">100%</option>
              <option value="90">90%</option>
              <option value="80">80%</option>
              <option value="70">70%</option>
              <option value="60">60%</option>
              <option value="50">50%</option>
              <option value="40">40%</option>
              <option value="30">30%</option>
            </select>
          </td>
          <td data-label="מחיר ל...">
            <input type="number" class="price-per-unit" min="0" step="0.01" inputmode="decimal" dir="ltr" placeholder="₪">
          </td>
          <td data-label="סה\"כ ללא מע\"מ" class="total-no-vat">0</td>
          <td data-label="מע\"מ (18%)" class="vat-amount">0</td>
          <td data-label="סה\"כ כולל מע\"מ" class="total-with-vat">0</td>
          <td data-label="חישוב"><button class="calculate">חשב</button></td>
        `;
        row.querySelector(".location").addEventListener("change", function () {
          const customLocation = row.querySelector(".custom-location");
          customLocation.classList.toggle("hidden", this.value !== "אחר");
        });
        row.querySelector(".work-type").addEventListener("change", function () {
          const customWork = row.querySelector(".custom-work");
          customWork.classList.toggle("hidden", this.value !== "אחר");
        });
        row.querySelector(".calculate").addEventListener("click", function () {
          calculateRow(row);
        });
        tableBody.appendChild(row);
      }

      // אתחול שורה ראשונה והוספת שורות נוספות בלחיצה
      createRow();
      addRowButton.addEventListener("click", createRow);

      // ניהול כפתורי ניווט (תיקון קישורים)
      document.getElementById("printButton").addEventListener("click", () => window.print());
      document.getElementById("homeButton").addEventListener("click", () => {
        window.location.href = "../index.html";
      });
      document.getElementById("quotationButton").addEventListener("click", () => {
        window.location.href = "../Quote-without-invoice/index.html";
      });
      document.getElementById("resetButton").addEventListener("click", () => {
        if (confirm("האם אתה בטוח שברצונך לאפס את הדף? כל הנתונים יאבדו.")) {
          location.reload();
        }
      });
      document.getElementById("rights").addEventListener("click", () => {
        window.location.href = "../Developerrights/index.html";
      });
    });

    // ניהול אזור החתימה
    const canvas = document.getElementById("signatureCanvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function startDrawing(e) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(getX(e), getY(e));
    }
    function stopDrawing() { drawing = false; }
    function draw(e) {
      if (!drawing) return;
      ctx.lineTo(getX(e), getY(e));
      ctx.stroke();
    }
    function getX(e) {
      if (e.touches) { return e.touches[0].clientX - canvas.getBoundingClientRect().left; }
      return e.clientX - canvas.getBoundingClientRect().left;
    }
    function getY(e) {
      if (e.touches) { return e.touches[0].clientY - canvas.getBoundingClientRect().top; }
      return e.clientY - canvas.getBoundingClientRect().top;
    }

    // אירועים לעכבר/מגע
    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("touchstart", (e) => { startDrawing(e); e.preventDefault(); });
    canvas.addEventListener("touchmove", (e) => { draw(e); e.preventDefault(); });
    canvas.addEventListener("touchend", (e) => { stopDrawing(e); e.preventDefault(); });

    // כפתור ניקוי חתימה
    document.getElementById("clearSignature").addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // פונקציה לשמירה והעברת הנתונים
    function saveQuote() {
      const quoteData = {
        title: document.getElementById("quoteTitle").value,
        recipient: document.getElementById("recipient").value,
        tableData: document.getElementById("tableData").value,
        signature: canvas.toDataURL("image/png")
      };
      localStorage.setItem("quoteData", JSON.stringify(quoteData));
      window.location.href = "../Quote-without-invoice/index.html";
    }
  </script>
</body>
</html>
